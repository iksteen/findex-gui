{% extends "helpers/base_home.jinja2" %}

{% block content %}

<style>
    body {
        background-color: #f5f5f5;
    }
    a:hover{
        text-decoration: none;
    }
    hr {
        margin-top: 10px;
        margin-bottom: 20px;
        border: 0;
        border-top: 1px solid #C7C7C7;
    }
    .container{
        width: 92%;
    }
    .dropdown.dropdown-lg .dropdown-menu {
        margin-top: -1px;
        padding: 20px 20px;
    }
    .input-group-btn .btn-group {
        display: flex !important;
    }
    .btn-group .btn {
        border-radius: 0;
        margin-left: -1px;
    }
    .btn-group .btn:last-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    .btn-group .form-horizontal .btn[type="submit"] {
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
    }
    .form-horizontal .form-group {
        margin-left: 0;
        margin-right: 0;
    }
    .form-group .form-control:last-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
    }

    @media screen and (min-width: 768px) {
        .dropdown.dropdown-lg {
            position: static !important;
        }
        .dropdown.dropdown-lg .dropdown-menu {
            min-width: 420px;
        }
    }
    #search_well {
        padding-top: 20px;
        border-left: 0;
        min-height: 800px;
        padding-left: 30px;
        box-shadow: 0px 0px 0px rgba(136, 136, 136, 0.12);
    }
    .menu_top {
        background-image: linear-gradient(to right, rgba(32, 90, 144, 0.79), rgba(78, 133, 165, 0.79));
    }
</style>

<div id="search_container" class="container" style="margin-top:80px;">
    <div class="row" style="padding-bottom:20px;">
        <div class="col-md-5">
            <h3>Search</h3>
            <div class="input-group" id="adv-search">
                <input id="inp_search" type="text" class="form-control" placeholder="Search for files" value=""/>
                <div class="input-group-btn">
                    <div class="btn-group" role="group">
                        <div class="dropdown dropdown-lg">
                            <button id="btn_filters" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span style="padding-right:8px;">Filters</span></button>
                            <!--<div class="dropdown-menu dropdown-menu-right" role="menu">-->
                                <!--:)-->
                            <!--</div>-->
                        </div>
                        <button id="btn_search" type="button" class="btn btn-primary"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10" style="max-width:750px;">
            <form id="form_filter" class="form-horizontal">
                <fieldset>
                    <div class="row">
                        <div id="filter_box" style="display:none;">
                            <div class="col-md-3" style="max-width:126px;">
                                <b>Files</b>
                                <div class="form-group">

                                    <div class="checkbox">
                                        <label><input type="checkbox" name="cats" value="0" checked>Undefined</label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" name="cats" value="1" checked>Documents</label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" name="cats" value="2" checked>Movies</label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" name="cats" value="3" checked>Music</label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" name="cats" value="4" checked>Pictures</label>
                                    </div>

                                </div>
                            </div>

                            <div class="col-md-3" style="max-width: 100px;">
                                <b>Protocols</b>
                                <div class="form-group">
                                    <div class="checkbox">
                                        <label><input type="checkbox" name="protocols" value="0" checked>FTP</label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" name="protocols" value="1" checked>HTTP</label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" name="protocols" value="2" checked>SMB</label>
                                    </div>
                                </div>

                                <b>Types</b>
                                <div class="form-group">
                                    <div class="radio">
                                      <label><input type="radio" value="1" name="type">Files</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="2" name="type">Folders</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="0" name="type" checked>Both</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3" style="max-width: 150px;">
                                <b>Size</b>
                                <div class="form-group">
                                    <div class="radio">
                                      <label><input type="radio" value="0" name="size" checked>Any size</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="1" name="size">0MB - 8MB</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="2" name="size">8MB - 128MB</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="3" name="size">128MB - 512MB</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="4" name="size">512MB - 2GB</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="5" name="size">2GB - 8GB</label>
                                    </div>
                                    <div class="radio">
                                      <label><input type="radio" value="6" name="size">More than 8GB</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4" style="max-width:160px;">
                                <b>Extensions</b>
                                <div class="form-group">
                                    <input id="tag1" name="exts" value="" />
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>

    <div id="search_results" class="row">
        <div class="col-md-10" id="search_well" style="padding-left:16px;">
            {% if message %}
            <h4 style="padding-bottom:10px;">{{message}}</h4>
            {% endif %}
        </div>
    </div>

</div>

<script>
    $(document).ready(function() {
        $('#inp_search').focus();
        $('#tag1').tagsInput({width:'auto', 'defaultText': 'Add an ext'});
    });

    var filters_shown = false;
    // to-do: move search specific stuff to search.js?
    argl = {
        'protocols': ['ftp', 'http', 'smb'],
        'cats': ['unknown', 'documents', 'movies', 'music', 'pictures']
    };

    function toggle_filters(animate) {
        var sel = $('#filter_box');

        if (!filters_shown){
            filters_shown = true;

            if(animate) {
                sel.css('margin-left', '-20px').css('opacity', '0');
            }
            sel.show();

            $('#btn_filters').addClass('btn-info');

            if(animate) {
                sel.stop().animate({'margin-left': '+=20', 'opacity': '1'}, 200);
            }
        } else {
            filters_shown = false;

            if(animate) {
                sel.stop().animate({'margin-left': '-=20', 'opacity': '0'}, 200);
            }

            $('#btn_filters').removeClass('btn-info');

            setTimeout(function(){
                sel.hide();
            }, 200);
        }
    }

    function reloadPage(){
        var data = $('#form_filter').serialize();

        var query = form_parse(data);
        goto_uri('/search?' + query);
    }

    function form_parse(inp){
        // meh
        var parsed = inp.split("&");
        var data = {};

        parsed.forEach(function(entry){
            var spl = entry.split("=");

            var key = spl[0];
            var val = '';

            if(key != "exts"){
                val = spl[1];

                if(key in argl){
                    val = argl[key][val];
                }
            } else {
                val = spl[1].split("%2C");
            }

            if (!(key in data)) {
                if(val instanceof Array){
                    data[key] = val;
                }
                else{
                    data[key] = [val];
                }
            }
            else{
                data[key].push(val);
            }

        });

        var query = '';

        for(key in data){
            query += key + '=[';

            for(var i = 0; i != data[key].length ; i++){
                query += data[key][i];
                if(i != data[key].length-1){
                    query += ','
                }
            }

            query += ']&';

        }
        query = query.substring(0, query.length - 1);
        query = 'key=' + encodeURIComponent($('#inp_search').val()) + '&' + query;
        return query;
    }

    $('#form_filter').submit(function(e){
        e.preventDefault();
        reloadPage();
    });

    $('#btn_search').click(function(){
       reloadPage();
    });

    $('#btn_filters').click(function () {
        toggle_filters(true);
    });

    $("#inp_search").keyup(function(e) {
        if (e.keyCode == 13) {
            reloadPage();
        }
    });
</script>

{% endblock %}